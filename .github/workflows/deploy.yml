name: Deploy

on:
  push:
    branches:
      - master

# on: 
#   workflow_run:
#     workflows: ["Build"]
#     types:
#       - completed

jobs:
  build:
    name: Deploy to Infra Codebase
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name : Check out repository code
        uses: actions/checkout@v4
        with:
          repository: clo-dso-test/jibaek-infra
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: main

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "COMMIT_SHORT_SHA=$calculatedSha" >> $GITHUB_ENV
        working-directory: jibaek-infra

      - name: Update Image SHA with yq
        run: |
          FILE_PATH="jibaek-infra/juice-shop/juice-shop.yaml"
          yq -i ".spec.containers[0].image = \"jibaek.azurecr.io/jibaek-sonarqube-test-juice-shop/jibaek-sonarqube-test-juice-shop:${{ env.COMMIT_SHORT_SHA }}\"" $FILE_PATH
          cat $FILE_PATH
    
      - name: Commit and Push Changes
        run: |
          cd jibaek-infra
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add juice-shop.yaml
          git commit -m "chore: update juice-shop image sha to ${{ env.COMMIT_SHORT_SHA }}"
          git push origin main

      - name: Finish Image Deploy to Infra Repo
        run: |
          echo "ðŸŽ‰ Finish Image Deploy to Infra Repo!!! ðŸŽ‰"